<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>购物流程_回头鱼全球购 - 美国,澳洲,日本,韩国,德国,香港海淘代购直邮网站！</title>
    <link rel="stylesheet" href="../css/car.css" />
    <link rel="stylesheet" href="../css/public.css" />
</head>
<body>
    <div id="top" class="floordiv">
        <div class="margin">
            <div class="t-left">
                <em>回头鱼商城欢迎您!</em>
                <a href="#" class="login">登录</a>
                <a href="#" class="register">免费注册</a>          
            </div>
            <div class="t-right">
                <ul class="t-ul">
                    <li class="mystores"><a href="#">我的订单</a></li>
                    <li class="mytaobao">
                        <div class="person">
                            <div class="menu1">
                                <a href="#" class="menu1-p">个人中心</a>
                                <b></b>
                            </div>
                            <div class="menu2">
                                <div class="menu-hd">
                                    <a href="#">优惠券</a>
                                    <a href="#">评价晒图</a>
                                    <a href="#">商品收藏</a>
                                    <a href="#">收货地址</a>
                                </div>
                            </div>
                        </div>
                    </li>  
                    <li class="mystores"><a href="#" class="kefu"><i></i>在线客服</a></li>
                    <li class="mystore">客服热线:&nbsp;&nbsp;<font>400-6699-840</font></li>
                </ul>
            </div>
        </div>
    </div>
    <div id="header">
        <div class="margin">
            <a href="index.html"><img src="../imgs/logo.gif"></a>
        </div>
    </div>
    <div id="car" style="border-left: none;border-right: none;">
        <div class="margin">
            <div class="tit">
                    <table cellpadding="0" cellspacing="0" width="100%" border="0">
                        <tbody>
                            <tr>
                              <td width="8%" align="center"><input type="checkbox" id="chkAll" name="chkAll" style="height:28px;vertical-align:middle;"><label for="chkAll">全选</label></td>
                              <td width="37%" align="center">商品</td>
                              <td width="15%" align="center">单价</td>
                              <td width="15%" align="center">数量</td>
                              <td width="15%" align="center">小计</td>
                              <td width="10%" align="center">操作</td>
                            </tr>
                        </tbody>
                    </table>
            </div>
            <form class="formchat">
                <table align="center" cellpadding="0" cellspacing="0" style="height:auto;width:100%;">
                        <tr>
                            <td style="height: 50px;border: 1px solid #eee;border-left: 0;border-right: 0;"><span style="color:#FFF;background:#ff666b;padding:0 3px;margin:0 10px 0 15px;">满减</span><a href="/category-2007-b0.html" target="_blank"> 活动商品参与<font style="color:#ff666b">满599减60 满899减100 满1699减200</font>，点击凑单&gt;&gt;</a>
                            </td>    
                        </tr>
                        
                    <tbody class="tbody1">
                            
                    </tbody>
                </table>
            </form>
            <div style="margin-top: 5px;">
                <a href="index.html" class="continue_buy">继续购物</a>
                <div class="te">
                    <span class="zongji">
                        总计（不含折扣）
                        <i class="xiaoji"></i>
                    </span>
                    <a href="#" class="checkout" style="color:#fff">去结算</a>
                </div>
            </div>
        </div>
    </div>
    
        <div id="footer" style="background: #f5f5f5;height: 100px;padding: 40px 0 20px;text-align: center;">
            <div class="info">
                <p class="nav_bottom">
                    <a href="#" target="_blank">网站简介</a><em>|</em>
                    <a href="#" target="_blank">联系我们</a><em>|</em>
                    <a href="#" target="_blank">招商合作</a><em>|</em>
                    <a href="#" target="_blank">用户协议</a><em>|</em>
                    <a href="#" target="_blank">隐私政策</a><em>|</em>
                    <a href="#" target="_blank">投诉建议</a>
                </p>
                <p>Copyright 2012 - 2019 www.huitouyu.com. All rights reserved. 回头鱼商城版权所有</p>
            </div>
        </div>
</body>
<script src="../js/ajax.js"></script>
<script src="../js/cookie.js"></script>
<script>
    class Car{
        constructor(){
            this.url = "http://localhost:86/json/goods.json";
            this.url2 = "http://localhost:86/json/goods2.json";
            this.tbody = document.querySelector(".tbody1");
            this.checkAll = document.querySelector("#chkAll");

            this.smoney=document.querySelector(".xiaoji");
            this.num = 0;
            this.smon=0;

            this.load();
            this.addEvent();
        }
        load(){
            ajaxGet(this.url,(res)=>{
                this.res = JSON.parse(res);

                this.getCookie();
            });
            ajaxGet(this.url2,(res)=>{
                this.res = JSON.parse(res);

                this.getCookie();
            });
        }
        getCookie(){
            this.goods = getCookie("goodsCookie")? JSON.parse(getCookie("goodsCookie")):[];

            this.display2();
            // this.display();
        }
        display2(){
            console.log(this.checkAll.checked)
            var str = "";
            for(var i=0;i<this.res.length;i++){
                for(var j=0;j<this.goods.length;j++){
                    
                    if(this.res[i].id == this.goods[j].id){
                        if(this.goods[j].check == 1){
                            this.check = "checked";
                            this.smon += this.goods[j].num*parseInt(this.res[i].price);
                        }else{
                            this.check = "";
                        }
                        var sub=parseInt(this.res[i].price)*this.goods[j].num
                        str += `<tr index="${this.res[i].id}">
                            <td style="width:100%;;border-left:1px solid #eee;border-right:1px solid #eee;">
                                <table cellpadding="5" cellspacing="1" border="0" width="100%" style="border:1px solid #eee;">
                                    <tbody>
                                        <tr> 
                                            <td align="center" width="5%">
                                                <input type="checkbox" class="check" ${this.check}>
                                            </td>
                                            <td align="center" width="40%">
                               
                                                <div class="thumb_name">
                                                    <dl>
                                                        <dt> <a href="product-23001.html" target="_blank"><img src="${this.res[i].url}" border="0" title="${this.res[j].name}"></a> </dt>
                                                        <dd> <a href="product-23001.html" target="_blank" class="f6">${this.res[j].name}</a>
                                                        <br>
                                                        <font class="attrname"></font> 
                                                        </dd>
                                                    </dl>
                                                </div>
                                            </td>
                                            <td align="center" width="15%">￥<font class="cart_jmprice" id="goods_price_6686547" style="color:#333;font-weight:normal;">${this.res[j].price}</font></td>
                                            <td align="center" width="15%">
                                                <div class="jm_cartnum"> 
                                                    <input type="number" value="${this.goods[j].num}" min=1 size="4" class="jminputBg">
                                                </div>
                                            </td>
             
                                            <td align="center" width="15%">￥<font class="cart_jmprice" id="subtotal_6686547" style="color:#333;font-weight:bold;">${sub}</font></td>
                                            <td class="delete" width="10%"style="cursor:pointer;">删除</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </td>
                        </tr>`;
                    }
                }
            }
            this.smoney.innerHTML = this.smon;
            this.smon=0;
            this.tbody.innerHTML = str;
        }
        
        addEvent(){
            var that = this;
            
            this.tbody.addEventListener("click",function(eve){
                var e = eve || window.event;
                var target = e.target || e.srcElement;
                if(target.className == "delete"){
                    that.id = target.parentNode.parentNode.parentNode.parentNode.parentNode.getAttribute("index");
                    target.parentNode.parentNode.parentNode.parentNode.parentNode.remove();
                    that.changeCookie(function(i){
                        that.goods.splice(i,1);
                    });
                }
                
                if(target.className == "check"){
                    that.id = target.parentNode.parentNode.parentNode.parentNode.parentNode.parentNode.getAttribute("index");
                    
                    that.bcheck(target);
                }
            })
            this.tbody.addEventListener("input",function(eve){
                var e = eve || window.event;
                var target = e.target || e.srcElement;
                if(target.className == "jminputBg"){
                    that.id = target.parentNode.parentNode.parentNode.parentNode.parentNode.parentNode.parentNode.getAttribute("index");
                    
                    target.parentNode.parentNode.nextElementSibling.children[0].innerHTML=
                    target.value*target.parentNode.parentNode.previousElementSibling.children[0].innerHTML
                    that.changeCookie(function(i){
                        that.goods[i].num = target.value;
                    });
                }
            })
            this.checkAll.onclick = function(){
                var acheck = document.querySelectorAll(".check");
                for(var i=0;i<acheck.length;i++){
                    if(this.checked == true){
                        
                        acheck[i].checked = true;
                        that.goods[i].check = 1;
                    }else{
                        acheck[i].checked = false;
                        that.goods[i].check = 0;
                    }
                }
                setCookie("goodsCookie",JSON.stringify(that.goods));
            }
           
        }
        changeCookie(cb){
            
            for(var i=0;i<this.goods.length;i++){
                if(this.id == this.goods[i].id){                 
                    cb(i);
                    break;
                }
            }
            setCookie("goodsCookie",JSON.stringify(this.goods));
        }
        bcheck(b){
            for(var i=0;i<this.goods.length;i++){               
                if(this.goods[i].id == this.id){                
                    if(this.goods[i].check == 1){
                        this.goods[i].check = 0;
                        b.checked = false;
                        
                    }else{
                        this.goods[i].check = 1;
                        b.checked = true;
                    }
                }
            }

            this.checkbox();
            setCookie("goodsCookie",JSON.stringify(this.goods));
            this.display2();    
        }
        checkbox(){
            var that = this;
            var a = this.goods.every(function(val,idx){
                if(that.goods[idx].check != 1){
                    return false;
                }else{
                    return true;
                }
            })
            if(a){
                this.checkAll.checked = true;
            }else{
                this.checkAll.checked = false;
            }
        }
       
    }
    new Car;
</script>
</html>